<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Caricatura SaaS - Embed</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 20px; background: #faf7f2; }
      .container { max-width: 820px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); padding: 20px; }
      h1 { font-size: 20px; margin: 0 0 12px; }
      .row { display: flex; gap: 16px; align-items: center; margin-bottom: 12px; }
      .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; }
      label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
      input[type="range"] { width: 100%; }
      .preview { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
      .card { border: 1px solid #eee; border-radius: 8px; padding: 12px; background: #fff; }
      .btn { padding: 10px 14px; border-radius: 8px; border: none; background: #2f6fed; color: #fff; cursor: pointer; }
      .btn:disabled { opacity: .6; cursor: default; }
      img { max-width: 100%; border-radius: 8px; }
      .footer { font-size: 12px; color: #666; text-align: center; margin-top: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Gerador de Caricatura (SaaS)</h1>
      <div class="row">
        <input id="file" type="file" accept="image/*" />
        <button id="btn" class="btn">Gerar caricatura</button>
      </div>
      <div class="controls">
        <div>
          <label>Eye scale <span id="eye_val">1.5</span></label>
          <input id="eye" type="range" min="1.0" max="2.5" step="0.05" value="1.5" />
        </div>
        <div>
          <label>Nose scale <span id="nose_val">1.15</span></label>
          <input id="nose" type="range" min="0.7" max="1.5" step="0.01" value="1.15" />
        </div>
        <div>
          <label>Mouth scale <span id="mouth_val">0.95</span></label>
          <input id="mouth" type="range" min="0.7" max="1.2" step="0.01" value="0.95" />
        </div>
        <div>
          <label>Stylize strength <span id="stylize_val">0.6</span></label>
          <input id="stylize" type="range" min="0.0" max="1.0" step="0.05" value="0.6" />
        </div>
      </div>

      <div class="preview">
        <div class="card">
          <strong>Original</strong>
          <img id="orig" alt="Original" />
        </div>
        <div class="card">
          <strong>Caricatura</strong>
          <img id="out" alt="Caricatura" />
        </div>
      </div>
      <div class="footer">Pronto para embutir via iframe em qualquer site.</div>
    </div>

    <script>
      const api = location.origin; // supõe backend no mesmo host
      const file = document.getElementById('file');
      const btn = document.getElementById('btn');
      const orig = document.getElementById('orig');
      const out = document.getElementById('out');
      const eye = document.getElementById('eye');
      const nose = document.getElementById('nose');
      const mouth = document.getElementById('mouth');
      const stylize = document.getElementById('stylize');
      const eyeVal = document.getElementById('eye_val');
      const noseVal = document.getElementById('nose_val');
      const mouthVal = document.getElementById('mouth_val');
      const stylizeVal = document.getElementById('stylize_val');

      const updateVal = () => {
        eyeVal.textContent = eye.value;
        noseVal.textContent = nose.value;
        mouthVal.textContent = mouth.value;
        stylizeVal.textContent = stylize.value;
      };
      [eye, nose, mouth, stylize].forEach(el => el.addEventListener('input', updateVal));
      updateVal();

      file.addEventListener('change', () => {
        const f = file.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => { orig.src = reader.result; };
        reader.readAsDataURL(f);
      });

      btn.addEventListener('click', async () => {
        const f = file.files?.[0];
        if (!f) return alert('Selecione uma imagem');
        btn.disabled = true; btn.textContent = 'Gerando...';
        try {
          const fd = new FormData();
          fd.append('file', f);
          fd.append('eye_scale', eye.value);
          fd.append('nose_scale', nose.value);
          fd.append('mouth_scale', mouth.value);
          fd.append('stylize_strength', stylize.value);
          const rsp = await fetch(`${api}/generate`, { method: 'POST', body: fd });
          if (!rsp.ok) throw new Error('Falha na geração');
          const blob = await rsp.blob();
          out.src = URL.createObjectURL(blob);
        } catch (e) {
          alert('Erro: ' + e.message);
        } finally {
          btn.disabled = false; btn.textContent = 'Gerar caricatura';
        }
      });
    </script>
  </body>
</html>
